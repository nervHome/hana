// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password_hash String   @map("password_hash")
  role          UserRole @default(EDITOR)
  hash_algo     String   @default("argon2id") // 方便迁移
  hash_meta     Json? // 可选：存储 timeCost/memoryCost/parallelism 等
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
}

enum UserRole {
  ADMIN
  EDITOR
}

model Epg {
  id       String  @id @default(cuid()) // 主键
  epgId    String  @unique @map("epg_id") // EPG 唯一标识
  name     String // EPG 名称
  xmlUrl   String? @map("xml_url") // EPG XML 文件地址
  language String? // 语言代码，如 "zh", "en"
  isActive Boolean @default(true) @map("is_active") // 是否启用
  remark   String? // 备注信息

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联关系
  channels       Channel[]
  channelSources ChannelSource[]
  programmes     Programme[]

  @@map("epg")
}

model Channel {
  id        String @id @default(cuid()) // 主键
  channelId String @map("channel_id") // 外部系统的频道 ID
  epgId     String @map("epg_id") // 所属 EPG 的 ID（外键）

  name      String   @map("name") // 频道名称
  logoUrl   String?  @map("logo_url") // 频道 LOGO
  language  String?  @map("language") // 语言（如 zh, en）
  country   String?  @map("country") // 国家/地区
  isActive  Boolean  @default(true) @map("is_active") // 是否启用
  remark    String? // 备注
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联关系
  epg           Epg             @relation(fields: [epgId], references: [epgId])
  programmes    Programme[]
  ChannelSource ChannelSource[]

  // 唯一约束：同一个 EPG 下，channelId 不重复
  @@unique([channelId, epgId])
  // 为常用查询建立索引
  @@index([epgId])
  @@map("channel")
}

model ChannelSource {
  id        String @id @default(cuid())
  channelId String @map("channel_id")
  epgId     String @map("epg_id")

  name      String // 直播源名称，如“高清”、“标清”、“备用CDN”
  url       String // 播放地址
  isActive  Boolean  @default(true) @map("is_active") // 是否启用
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  epg     Epg     @relation(fields: [epgId], references: [epgId])
  channel Channel @relation(fields: [channelId, epgId], references: [channelId, epgId])

  @@index([channelId, epgId])
  @@map("channel_source")
}

model Programme {
  id        String @id @default(cuid())
  channelId String @map("channel_id")
  epgId     String @map("epg_id")

  title     String
  startTime DateTime @map("start_time")
  endTime   DateTime @map("end_time")
  duration  Int? // 自动计算的时长（分钟）

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  epg     Epg     @relation(fields: [epgId], references: [epgId])
  channel Channel @relation(fields: [channelId, epgId], references: [channelId, epgId])

  @@unique([channelId, epgId, startTime]) // 避免重复节目
  @@index([channelId, epgId])
  @@map("programme")
}
