# 📊 EPG Admin Service 架构图

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端应用                                   │
│                 (Web App / Mobile)                         │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTP/HTTPS + JWT
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   Nginx 反向代理                              │
│              (生产环境 - 端口 80/443)                          │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  NestJS 应用服务                              │
│                   (端口 4000)                               │
│  ┌─────────────┐ ┌──────────────┐ ┌─────────────────────┐    │
│  │  Auth模块   │ │   Users模块   │ │     Common模块      │    │
│  │            │ │              │ │                     │    │
│  │ JWT策略     │ │ 用户管理      │ │ 日志/异常处理        │    │
│  │ 黑名单机制   │ │ 密码加密      │ │ 数据验证             │    │
│  │ 路由守卫     │ │ 角色权限      │ │ EPG数据处理         │    │
│  └─────────────┘ └──────────────┘ └─────────────────────┘    │
└─────────────────────┬───────────────────────────────────────┘
                      │ Prisma ORM
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                PostgreSQL 数据库                              │
│                   (端口 5432)                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  用户表 (User)                                      │    │
│  │  - id, email, password_hash                        │    │
│  │  - role, hash_algo, hash_meta                      │    │
│  │  - createdAt, updatedAt                           │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 数据流图

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   客户端     │───▶│  认证授权    │───▶│  业务逻辑    │───▶│   数据库     │
│   请求      │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
      ▲                   │                   │                   │
      │                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   响应数据   │◀───│  JWT令牌     │◀───│  数据处理    │◀───│  查询结果    │
│   JSON格式   │    │  验证/生成   │    │  格式化     │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 🛡️ 安全架构

```
┌─────────────────────────────────────────────────────────────┐
│                     安全层级                                  │
│                                                             │
│  第1层: 网络安全                                              │
│  ├─ Nginx 反向代理                                           │
│  ├─ 端口访问控制                                              │
│  └─ SSL/TLS 加密                                            │
│                                                             │
│  第2层: 应用安全                                              │
│  ├─ JWT 令牌认证                                             │
│  ├─ 令牌黑名单机制                                            │
│  ├─ 路由守卫                                                │
│  └─ 角色权限控制                                              │
│                                                             │
│  第3层: 数据安全                                              │
│  ├─ Argon2 密码加密                                          │
│  ├─ SQL注入防护                                              │
│  ├─ 数据验证                                                │
│  └─ 敏感信息脱敏                                              │
│                                                             │
│  第4层: 基础设施安全                                           │
│  ├─ Docker 容器隔离                                          │
│  ├─ 非root用户运行                                           │
│  ├─ 资源限制                                                │
│  └─ 健康检查                                                │
└─────────────────────────────────────────────────────────────┘
```

## 📦 模块依赖关系

```
AppModule
├── ConfigModule (全局配置)
├── LoggerModule (日志管理)
├── CommonModule (公共模块)
│   ├── PrismaService (数据库服务)
│   ├── Filters (异常过滤器)
│   ├── Interceptors (拦截器)
│   └── Helpers (工具函数)
├── AuthModule (认证模块)
│   ├── AuthService (认证服务)
│   ├── JwtStrategy (JWT策略)
│   ├── JwtBlacklistService (黑名单服务)
│   └── JwtAuthGuard (路由守卫)
└── UsersModule (用户模块)
    ├── UsersService (用户服务)
    ├── UserDao (数据访问)
    └── UsersController (控制器)
```

## 🔄 认证流程

```
1. 用户登录
   ┌─────────┐    POST /auth/login    ┌─────────────┐
   │  客户端  │─────────────────────▶│ AuthService │
   └─────────┘                      └─────────────┘
                                           │
                                           ▼
                                    ┌─────────────┐
                                    │ 验证用户密码  │
                                    └─────────────┘
                                           │
                                           ▼
                                    ┌─────────────┐
                                    │ 生成JWT令牌  │
                                    └─────────────┘

2. 请求认证
   ┌─────────┐   Header: Bearer JWT   ┌─────────────┐
   │  客户端  │─────────────────────▶│ JwtAuthGuard│
   └─────────┘                      └─────────────┘
                                           │
                                           ▼
                                    ┌─────────────┐
                                    │ 验证JWT令牌  │
                                    └─────────────┘
                                           │
                                           ▼
                                    ┌─────────────┐
                                    │ 检查黑名单   │
                                    └─────────────┘
                                           │
                                           ▼
                                    ┌─────────────┐
                                    │ 允许访问    │
                                    └─────────────┘

3. 用户登出
   ┌─────────┐   POST /auth/logout   ┌─────────────┐
   │  客户端  │─────────────────────▶│ AuthService │
   └─────────┘                      └─────────────┘
                                           │
                                           ▼
                                    ┌─────────────┐
                                    │ 添加到黑名单  │
                                    └─────────────┘
```

## 📊 数据库模型

```
User 表
┌─────────────────┬─────────────┬──────────────────┐
│     字段名       │    类型      │      描述         │
├─────────────────┼─────────────┼──────────────────┤
│ id              │ String      │ 主键(CUID)       │
│ email           │ String      │ 邮箱(唯一)        │
│ password_hash   │ String      │ 密码哈希          │
│ role            │ UserRole    │ 用户角色          │
│ hash_algo       │ String      │ 哈希算法          │
│ hash_meta       │ Json?       │ 哈希参数          │
│ createdAt       │ DateTime    │ 创建时间          │
│ updatedAt       │ DateTime    │ 更新时间          │
└─────────────────┴─────────────┴──────────────────┘

UserRole 枚举
┌─────────────────┬──────────────────────────────┐
│     角色        │            权限               │
├─────────────────┼──────────────────────────────┤
│ ADMIN           │ 用户管理、系统配置、数据管理    │
│ EDITOR          │ 数据编辑、内容管理            │
└─────────────────┴──────────────────────────────┘
```
